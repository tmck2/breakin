<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" type="text/css" href="styles.css" />
<link href="https://fonts.googleapis.com/css?family=Orbitron:900" rel="stylesheet">
<script>
  var breakin = breakin || {};

  breakin.history = (function () {
    max_frames = 4000;
    current = 0;
    undoHistory = [];

    function rewind(frames) {
      if (current - frames < 0) {
        current = 0;
      } else {
        current -= frames;
      }
      return undoHistory[current];
    }

    function fastForward(frames) {
      if (current + frames >= undoHistory.length) {
        current = undoHistory.length - 1;
      } else {
        current = current + frames;
      }
      return undoHistory[current];
    }

    function saveState(state) {
      undoHistory[current++] = state;
      while (current > max_frames) {
        undoHistory = undoHistory.slice(1);
        current--;
      }
    }

    return {
      saveState: saveState,
      rewind: rewind,
      fastForward: fastForward
    }
  })();

  sounds = {}
  function playSound(filename, volume, loop) {
    if (sounds[filename] == undefined)
      sounds[filename] = new Audio(filename);
    snd = sounds[filename];
    snd.currentTime = 0;
    snd.volume = volume;
    snd.loop = loop;
    snd.play();
  }

  function getHighScore() {
    if (localStorage.highScore)
      return +localStorage.highScore;
    return 0;
  }
  function saveScoreIfNewBest(score) {
    best = getHighScore();
    if (score > best) {
      localStorage.highScore = score;
      app.ports.updateHighScore.send(score);
    }
  }
</script>
</head>
<div id="main"></div>
<script src="breakin.js"></script>
<script>
    var node = document.getElementById('main');
    var app = Elm.Main.embed(node);
    app.ports.playSound.subscribe(function (params) {
      var volume = params[0];
      var loop = params[1];
      var filename = params[2];
      playSound(filename, volume, loop);
    });
    app.ports.saveState.subscribe(function (state) {
      breakin.history.saveState(state);
    });
    app.ports.rewind.subscribe(function () {
      app.ports.updateModel.send(breakin.history.rewind(1));
    });
    app.ports.fastforward.subscribe(function() {
      app.ports.updateModel.send(breakin.history.fastForward(1));
    });
    app.ports.saveHighScore.subscribe(function(score) {
      saveScoreIfNewBest(score);
    });
    app.ports.getHighScore.subscribe(function() {
      score = getHighScore();
      app.ports.updateHighScore.send(score);
    });
</script>
</html>
